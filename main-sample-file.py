"""
main.py - ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ã†ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«

å®Ÿè¡Œæ–¹æ³•:
    PS C:\Users\yukik\Desktop\excel> py main.py
"""

# ===================================================================
# é‡è¦ï¼ã¾ãšã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# ===================================================================

from logging_decorators import (
    log_call,
    log_time,
    log_errors,
    retry,
    log_all
)
import time


# ===================================================================
# ä¾‹1: åŸºæœ¬çš„ãªä½¿ã„æ–¹
# ===================================================================

@log_call
def add_numbers(a, b):
    """2ã¤ã®æ•°ã‚’è¶³ã™"""
    return a + b


@log_time
def slow_function():
    """æ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†"""
    time.sleep(0.5)
    return "å®Œäº†"


@log_errors
def risky_function(x):
    """ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹é–¢æ•°"""
    return 10 / x


# ===================================================================
# ä¾‹2: è¤‡æ•°ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’çµ„ã¿åˆã‚ã›
# ===================================================================

@log_errors
@log_time
@log_call
def calculate_tax(price, rate):
    """ç¨è¾¼ä¾¡æ ¼ã‚’è¨ˆç®—"""
    time.sleep(0.1)  # å‡¦ç†æ™‚é–“ã®æ¨¡æ“¬
    return price * (1 + rate)


# ===================================================================
# ä¾‹3: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
# ===================================================================

attempt_count = 0

@retry(max_attempts=3, delay=0.5)
def unstable_api_call():
    """ä¸å®‰å®šãªAPIå‘¼ã³å‡ºã—ã®æ¨¡æ“¬"""
    global attempt_count
    attempt_count += 1
    
    # 2å›ç›®ã§æˆåŠŸã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
    if attempt_count < 2:
        raise ConnectionError("ä¸€æ™‚çš„ãªæ¥ç¶šã‚¨ãƒ©ãƒ¼")
    
    return {"status": "success", "data": "å–å¾—å®Œäº†"}


# ===================================================================
# ä¾‹4: å…¨éƒ¨ç››ã‚Š
# ===================================================================

@log_all
def important_function(x, y):
    """é‡è¦ãªé–¢æ•°ï¼ˆå…¨ã¦ã®ãƒ­ã‚°ã‚’å‡ºåŠ›ï¼‰"""
    time.sleep(0.05)
    return x * y


# ===================================================================
# ä¾‹5: å®Ÿå‹™çš„ãªä½¿ç”¨ä¾‹
# ===================================================================

@log_errors
@log_time
def load_data_from_file(filename):
    """ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€"""
    print(f"ãƒ•ã‚¡ã‚¤ãƒ« {filename} ã‚’èª­ã¿è¾¼ã¿ä¸­...")
    time.sleep(0.2)  # ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã®æ¨¡æ“¬
    return {"users": 100, "products": 50}


@log_call
@retry(max_attempts=2, delay=1.0)
def save_to_database(data):
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜"""
    print(f"ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­: {data}")
    time.sleep(0.1)
    return True


# ===================================================================
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# ===================================================================

def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    print("=" * 70)
    print("ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ ãƒ‡ãƒ¢ãƒ—ãƒ­ã‚°ãƒ©ãƒ ")
    print("=" * 70)
    
    # ä¾‹1: åŸºæœ¬çš„ãªé–¢æ•°å‘¼ã³å‡ºã—
    print("\nâ–  ä¾‹1: åŸºæœ¬çš„ãªä½¿ã„æ–¹")
    print("-" * 70)
    result = add_numbers(3, 5)
    print(f"çµæœ: {result}")
    
    # ä¾‹2: æ™‚é–“è¨ˆæ¸¬
    print("\nâ–  ä¾‹2: å®Ÿè¡Œæ™‚é–“ã®è¨ˆæ¸¬")
    print("-" * 70)
    slow_function()
    
    # ä¾‹3: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    print("\nâ–  ä¾‹3: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°")
    print("-" * 70)
    
    # æ­£å¸¸ãªã‚±ãƒ¼ã‚¹
    result = risky_function(2)
    print(f"æ­£å¸¸ãªçµæœ: {result}")
    
    # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã‚±ãƒ¼ã‚¹
    try:
        risky_function(0)
    except ZeroDivisionError:
        print("â†’ ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦å‡¦ç†ã—ã¾ã—ãŸ")
    
    # ä¾‹4: è¤‡æ•°ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼
    print("\nâ–  ä¾‹4: è¤‡æ•°ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®çµ„ã¿åˆã‚ã›")
    print("-" * 70)
    tax_price = calculate_tax(1000, 0.1)
    print(f"ç¨è¾¼ä¾¡æ ¼: {tax_price}å††")
    
    # ä¾‹5: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
    print("\nâ–  ä¾‹5: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½")
    print("-" * 70)
    global attempt_count
    attempt_count = 0  # ãƒªã‚»ãƒƒãƒˆ
    api_result = unstable_api_call()
    print(f"APIçµæœ: {api_result}")
    
    # ä¾‹6: å…¨éƒ¨ç››ã‚Š
    print("\nâ–  ä¾‹6: å…¨éƒ¨ç››ã‚Š (@log_all)")
    print("-" * 70)
    result = important_function(7, 8)
    print(f"è¨ˆç®—çµæœ: {result}")
    
    # ä¾‹7: å®Ÿå‹™çš„ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼
    print("\nâ–  ä¾‹7: å®Ÿå‹™çš„ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼")
    print("-" * 70)
    
    # ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    data = load_data_from_file("users.json")
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
    save_to_database(data)
    
    print("\n" + "=" * 70)
    print("ãƒ‡ãƒ¢å®Œäº†ï¼")
    print("=" * 70)


# ===================================================================
# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
# ===================================================================

if __name__ == "__main__":
    main()


"""
============================================================
æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹:
============================================================

======================================================================
ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ ãƒ‡ãƒ¢ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
======================================================================

â–  ä¾‹1: åŸºæœ¬çš„ãªä½¿ã„æ–¹
----------------------------------------------------------------------
[2025-01-10 10:30:15] INFO     â†’ å‘¼ã³å‡ºã—: add_numbers(3, 5)
[2025-01-10 10:30:15] INFO     â† å®Œäº†: add_numbers() â†’ 8
çµæœ: 8

â–  ä¾‹2: å®Ÿè¡Œæ™‚é–“ã®è¨ˆæ¸¬
----------------------------------------------------------------------
[2025-01-10 10:30:15] INFO     â± slow_function() ã®å®Ÿè¡Œæ™‚é–“: 500.25ms

â–  ä¾‹3: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
----------------------------------------------------------------------
[2025-01-10 10:30:16] INFO     â†’ å‘¼ã³å‡ºã—: risky_function(2)
[2025-01-10 10:30:16] INFO     â† å®Œäº†: risky_function() â†’ 5.0
æ­£å¸¸ãªçµæœ: 5.0
[2025-01-10 10:30:16] ERROR    âŒ risky_function() ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ZeroDivisionError: division by zero
â†’ ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦å‡¦ç†ã—ã¾ã—ãŸ

â–  ä¾‹4: è¤‡æ•°ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®çµ„ã¿åˆã‚ã›
----------------------------------------------------------------------
[2025-01-10 10:30:16] INFO     â†’ å‘¼ã³å‡ºã—: calculate_tax(1000, 0.1)
[2025-01-10 10:30:16] INFO     â± calculate_tax() ã®å®Ÿè¡Œæ™‚é–“: 100.15ms
[2025-01-10 10:30:16] INFO     â† å®Œäº†: calculate_tax() â†’ 1100.0
ç¨è¾¼ä¾¡æ ¼: 1100.0å††

â–  ä¾‹5: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
----------------------------------------------------------------------
[2025-01-10 10:30:16] INFO     ğŸ”„ unstable_api_call() è©¦è¡Œ 1/3
[2025-01-10 10:30:16] WARNING  âš ï¸ unstable_api_call() å¤±æ•—ï¼ˆ1/3ï¼‰: ä¸€æ™‚çš„ãªæ¥ç¶šã‚¨ãƒ©ãƒ¼
[2025-01-10 10:30:16] INFO     â³ 0.5ç§’å¾…æ©Ÿå¾Œã«å†è©¦è¡Œ...
[2025-01-10 10:30:17] INFO     ğŸ”„ unstable_api_call() è©¦è¡Œ 2/3
[2025-01-10 10:30:17] INFO     âœ… unstable_api_call() æˆåŠŸï¼ˆ2å›ç›®ã§æˆåŠŸï¼‰
APIçµæœ: {'status': 'success', 'data': 'å–å¾—å®Œäº†'}

======================================================================
ãƒ‡ãƒ¢å®Œäº†ï¼
======================================================================
"""